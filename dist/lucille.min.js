var Lucille=function(a){var b={};b.chart={width:320,height:520},b.fretboard={width:120,height:250},b.orientation="RIGHTY",b.instrument=this.Instrument,b.plukit=new Plukit,b.pattern="strum",b.tab=this.getTab("C","M",this.Instrument.tuning),b.theme="zen",_.extend(this,b,a),this.themeLoad(),this.render(),this.display(),this.updateTypeText("Major"),this.updateMinifiedTitle("C","Major"),this.trackSwipes()};Lucille.prototype.Fixture=function(){var a={theme:{plain:{background:"#e2e2e2",touchTargetBackground:"#e2e2e2"}},guitar:{root:"C",type:"Major",caged:[0,1],voicings:[[{fret:0,finger:0,note:"E"},{fret:1,finger:0,note:"C"},{fret:0,finger:0,note:"G"},{fret:2,finger:0,note:"E"},{fret:3,finger:0,note:"C"},{fret:null,finger:null,note:null}],[{fret:3,finger:0,note:"G"},{fret:5,finger:0,note:"D"},{fret:5,finger:0,note:"C"},{fret:5,finger:0,note:"G"},{fret:3,finger:0,note:"C"},{fret:3,finger:0,note:"G"}]]}};return a}(),Lucille.prototype.Instrument=function(){var a={strings:6,tuning:["e2","a2","d3","g3","b3","e4"]};return a}(),Lucille.prototype.calcVoicing=function(){return this.tab.voicings[this.tab.caged[0]]},Lucille.prototype.calcLayout=function(){var a={};return a.chart=this.chart,a.fretboard=this.fretboard,a.strings=this.calcStringLayout(),a.frets=this.calcFretLayout(),a},Lucille.prototype.calcStringLayout=function(){for(var a=this,b=this.instrument.strings,c=this.fretboard.width/(b-1),d=.025*this.fretboard.height,e=_.times(b,function(a){return a*c}),f=_.times(b,function(a){return a*c}),g=_.times(b,function(){return 0}),h=_.times(b,function(){return a.fretboard.height}),i=0,j=0,k=b-1;k>=j;j++,k--)g[j]=i,g[k]=i,i+=d;return"RIGHTY"===this.orientation&&(e.reverse(),f.reverse(),g.reverse(),h.reverse()),{x1:e,x2:f,y1:g,y2:h,spacing:c}},Lucille.prototype.calcFretLayout=function(){var a,b,c=this.calcVoicing(),d=null;return a=_.sortBy(c,function(a){return a.fret}),a=_.pluck(a,"fret"),a=_.compact(a),a=_.filter(a,function(a){return a>-1}),a=_.range(_.first(a),_.last(a)+1),b=this.fretboard.height/a.length,d=_.times(a.length,function(a){return(a+1)*b}),{y:d,range:a,spacing:b}},Lucille.prototype.render=function(){this.svg=Snap(this.chart.width,this.chart.height).attr("class","lucille"),this.lucille=this.renderContainer(),this.lucille.background=this.renderBackground(),this.lucille.chord=this.renderChord(),this.lucille.fretboard=this.renderFretboard(),this.lucille.strings=this.renderStrings(),this.lucille.frets=this.renderFrets(),this.lucille.frettings=this.renderFrettings(),this.lucille.buttons=this.renderButtons(),this.lucille.settings=this.renderSettings(),this.lucille.picker=this.renderPicker(),this.lucille.minified=this.renderMinified(),this.lucille.minified.background=this.renderMinifiedBackground(),this.lucille.minified.buttons=this.renderMinifiedButtons(),this.lucille.minified.title=this.renderMinifiedTitle()},Lucille.prototype.renderContainer=function(){var a=this.svg.g();return a.attr({"class":"main"}),a},Lucille.prototype.renderBackground=function(){var a=this.lucille.rect(0,0,this.chart.width,this.chart.height);return a.attr({"class":"background"}),a},Lucille.prototype.renderChord=function(){{var a=(this.chart.width-100)/2,b=10,c=this.lucille.g().attr({"class":"chord button",transform:"translate("+a+","+b+")"});c.rect(0,0,100,100).attr("class","touchTarget"),c.text(50,50,this.tab.root).attr("class","root"),c.text(50,90,this.tab.type).attr("class","type")}return c.click(function(){this.lucille.picker.display()},this),c},Lucille.prototype.renderFretboard=function(){var a=this.calcLayout(),b=this.lucille.g(),c=(a.chart.width-a.fretboard.width)/2,d=(a.chart.height-a.fretboard.height)/2+15;return b.attr({"class":"fretboard",transform:"translate("+c+","+d+")"}),b},Lucille.prototype.renderFretboardRefresh=function(){this.lucille.fretboard.clear(),this.lucille.strings=this.renderStrings(),this.lucille.frets=this.renderFrets(),this.lucille.frettings=this.renderFrettings()},Lucille.prototype.renderStrings=function(){var a=this.calcLayout(),b=this.lucille.fretboard.g().attr("class","strings");return _.times(a.strings.x1.length,function(c){var d=a.strings.x1[c],e=a.strings.x2[c],f=a.strings.y1[c],g=a.strings.y2[c],h=b.line(d,f,e,g);h.attr({"class":"string"})}),b.selectAll(".string")},Lucille.prototype.renderFrets=function(){var a=null!==this.lucille.fretboard.select(".frets"),b=this.calcLayout(),c=!0===a?this.lucille.fretboard.select(".frets"):this.lucille.fretboard.g().attr("class","frets");return c.clear(),_.each(b.frets.y,function(a){var d=c.line(0,a,b.fretboard.width,a);d.attr({"class":"fret"})}),c.selectAll(".fret")},Lucille.prototype.renderFrettings=function(){var a=this,b=this.calcLayout(),c=this.lucille.fretboard.g().attr("class","frettings"),d=11,e=this.calcVoicing();return _.times(b.strings.x1.length,function(f){{var g=b.strings.x1[f],h=b.fretboard.height/2,i=c.g().attr({"class":"fretting"}),j=(i.circle(g,h,d).attr("class","dot"),i.line(g,h,g,a.fretboard.height).attr("class","string")),k=b.strings.y1[f]-15,l=null===e[f].fret?"X":e[f].fret.toString(),m=(i.text(g,k,l).attr("class","tab label"),b.strings.y2[f]+15),n=null===e[f].note?"X":e[f].note;i.text(g,m,n).attr("class","note label"),e[f].obj.inverted}i.click(function(){a.playString(f)},this),j.data("x",g)}),c.selectAll(".fretting")},Lucille.prototype.renderButtons=function(){{var a=this,b=this.calcLayout(),c=this.lucille.g().attr("class","buttons"),d=b.chart.width-(b.chart.width-b.fretboard.width)/2/2,e=b.chart.height/2,f=c.g();f.rect(-25,-25,50,50).attr({"class":"touchTarget"}),f.text(0,0,"\uf054")}f.click(this.displayNext,this),f.attr({"class":"button next",transform:"translate("+d+","+e+")"});{var g=(b.chart.width-b.fretboard.width)/2/2,h=b.chart.height/2,i=c.g();i.rect(-25,-25,50,50).attr("class","touchTarget"),i.text(0,0,"\uf053")}i.click(this.displayPrev,this),i.attr({"class":"button prev",transform:"translate("+g+","+h+")"});{var j=b.chart.width/2,k=b.chart.height-(b.chart.height-b.fretboard.height)/2/2+10,l=c.g().attr("class","play");l.rect(-25,-25,50,50).attr("class","touchTarget"),l.text(0,0,"\uf028")}l.data("active",!1),l.click(function(){a.play()},this),l.attr({"class":"button play",transform:"translate("+j+","+k+")"});{var m=b.chart.width-(b.chart.width-b.fretboard.width)/2/2,n=(b.chart.width-b.fretboard.width)/2/2,o=c.g();o.rect(-25,-25,50,50).attr("class","touchTarget"),o.text(0,0,"\uf0c9")}o.click(function(){this.lucille.settings.display()},this),o.attr({"class":"button settings",transform:"translate("+m+","+n+")"});{var p=(b.chart.width-b.fretboard.width)/2/2,q=(b.chart.width-b.fretboard.width)/2/2,r=c.g();r.rect(-25,-25,50,50).attr("class","touchTarget"),r.text(0,0,"\uf068")}return r.click(this.displayMinified,this),r.attr({"class":"button collapse",transform:"translate("+p+","+q+")"}),c.selectAll(".button")},Lucille.prototype.renderSettings=function(){var a=this.configSettings(),b=this,c=function(a){b.updateSettings(a)},d=this.lucille.g(),e=new Pickl({svg:d,callback:c,config:a});return e},Lucille.prototype.renderPicker=function(){var a=this.configPicker(),b=this,c=function(a){b.updateChord(a)},d=this.lucille.g(),e=new Pickl({svg:d,callback:c,config:a});return e},Lucille.prototype.renderMinified=function(){var a=this.svg.g();return a.attr({"class":"minified",display:"none"}),a},Lucille.prototype.renderMinifiedBackground=function(){var a=this.lucille.minified.rect(0,0,this.chart.width,50);return a.attr({"class":"background"}),a},Lucille.prototype.renderMinifiedButtons=function(){var a,b,c,d,e,f=this,g=this.calcLayout(),h=null;return a=25,b=25,c=this.lucille.minified.g().attr("class","buttons"),d=c.g(),e=d.rect(-25,-25,50,50).attr("class","touchTarget"),h=d.text(0,0,"\uf067"),d.click(this.displayMinifiedHidden,this),d.attr({"class":"button collapse",transform:"translate("+a+","+b+")"}),a=g.chart.width-25,b=25,c=this.lucille.minified.g().attr("class","buttons"),d=c.g(),e=d.rect(-25,-25,50,50).attr("class","touchTarget"),h=d.text(0,0,"\uf028"),d.click(function(){f.play()},this),d.attr({"class":"button collapse",transform:"translate("+a+","+b+")"}),c},Lucille.prototype.renderMinifiedTitle=function(){var a=(this.calcLayout(),this.chart.width/2),b=25,c=this.tab.root,d=this.tab.type,e=c+" "+d,f=this.lucille.minified.text(a,b,e).attr({"class":"title"});return f},Lucille.prototype.display=function(){var a=this.calcVoicing(),b=this.calcLayout(),c=b.frets,d=this.lucille.frettings;this.renderFrets(),_.each(a,function(a,e){var f=d[e],g=_.indexOf(c.range,a.fret),h=-1===g?0:g,i=!0===a.obj.inverted,j=f.select(".dot"),k=!0===i?"disabled":"",l=-1===g?"dot hide":"dot "+k,m=c.y[h]-c.spacing/2;j.attr({"class":l}),j.animate({cy:m},700,mina.backout);var n=f.select(".string"),o=!0===i?"disabled":"",p=-1===a.fret?"string hide":"string "+o,q=0===a.fret?b.strings.y1[e]:c.y[h]-c.spacing/2;n.attr({"class":p}),n.animate({y1:q},700,mina.backout);var r=f.select(".tab"),s=-1===a.fret?"X":a.fret;r.node.textContent=s;var t=f.select(".note"),u=null===a.note?"X":a.note;t.node.textContent=u})},Lucille.prototype.displayNext=function(){var a=this.tab.caged[0],b=this.tab.caged[1],c=a+1>b?0:a+1;this.tab.caged[0]=c,this.display()},Lucille.prototype.displayPrev=function(){var a=this.tab.caged[0],b=this.tab.caged[1],c=0>a-1?b:a-1;this.tab.caged[0]=c,this.display()},Lucille.prototype.displayOrientation=function(a){this.orientation=a,this.renderFretboardRefresh(),this.display()},Lucille.prototype.displayMinified=function(){this.lucille.minified.attr("display",""),this.lucille.attr("display","none"),this.svg.attr("height",50)},Lucille.prototype.displayMinifiedHidden=function(){this.lucille.minified.attr("display","none"),this.lucille.attr("display",""),this.svg.attr("height",this.chart.height)},Lucille.prototype.play=function(a){var b=this,c=this.lucille.buttons[2];if(!c.data("active")){c.data("active",!0),setTimeout(function(){b.lucille.buttons[2].data("active",!1)},2e3);var d=(_.map(this.calcVoicing(),function(a){return a.note}),this.getCurrentVoicing()),e=_.filter(d,function(a){return a.fret>-1&&a.obj.inverted===!1}),a=(_.map(e,function(a){return a.obj.key()}),_.map(e,function(a){return a.obj.toString()}),a||"down"),f="down"===a?_.eachRight:_.each,g=65;f(e,function(a,c){null!==a&&(window.setTimeout(function(){b.playString(c)},g),g+=65)})}},Lucille.prototype.playString=function(a){var b=this.lucille.frettings[a].select(".string"),c=this.getCurrentVoicing(),d=(c[a].obj.key(),c[a].obj.toString()),e=function(){clearInterval(j),b.attr({"stroke-opacity":1,strokeWidth:5})},f=50,g=2e3,h=0;e();var i=function(){h+=f;var a=h/g,c=.5>a?.5:a,d=.5>1-a?5:10*(1-a);b.attr({"stroke-opacity":c,"stroke-width":d}),h>=g&&e()},j=setInterval(i,f);this.plukit.play(d)},Lucille.prototype.updateSettings=function(a){this.orientation=a.orientation.value,this.instrument.tuning=a.tuning.value,this.tab=this.getTab(this.tab.root,this.tab.type,this.instrument.tuning),this.renderFretboardRefresh(),this.plukit=new Plukit({sampleFile:a.preview.value,samplePath:this.plukit.settings.samplePath,device:this.plukit.settings.device}),this.display()},Lucille.prototype.updateChord=function(a){this.updateRootText(a.root.name),this.updateTypeText(a.type.name),this.updateMinifiedTitle(a.root.name,a.type.name),this.tab=this.getTab(a.root.value,a.type.value,this.instrument.tuning),this.renderFretboardRefresh(),this.display()},Lucille.prototype.updateRootText=function(a){this.lucille.chord.select(".root").node.textContent=a},Lucille.prototype.updateTypeText=function(a){this.lucille.chord.select(".type").node.textContent=a},Lucille.prototype.updateMinifiedTitle=function(a,b){this.lucille.minified.title.node.textContent=a+" "+b},Lucille.prototype.transToTabulousChordType=function(a){var b="";switch(a){case"Major":b="";break;case"minor":b="m"}return b},Lucille.prototype.transTabulousChordToVoicings=function(a){var b=_.map(a.voicings,function(a){return _.map(a.data,function(b,c){var d=null===b?null:b.toString(!0).charAt(0).toUpperCase()+b.toString(!0).charAt(1);return{fret:a.voicing[c],finger:0,note:d,obj:b}})});return b=_.map(b,function(a){return a.reverse()})},Lucille.prototype.getTab=function(a,b,c){var c=c||this.instrument.tuning,d=new Tabulous({root:a,type:b,tuning:c}),e=this.transTabulousChordToVoicings(d),f={root:a,type:b,caged:[0,e.length-1],voicings:e,chord:d.chord};return f},Lucille.prototype.getCurrentVoicing=function(){return this.tab.voicings[this.tab.caged[0]]},Lucille.prototype.getInstrument=function(a){var a=null;switch(name){case"Guitar":a=this.Instrument.guitar;break;case"Mandolin":a=this.Instrument.mandolin}return a},Lucille.prototype.trackSwipes=function(){{var a=this.calcLayout(),b=(a.chart.width-a.fretboard.width)/2;(a.chart.height-a.fretboard.height)/2+15,_.map(this.lucille.frettings,function(a){return parseInt(a.select(".string").attr("x1"))+b})}},Lucille.prototype.destroy=function(){this.lucille.remove(),this.svg.remove(),delete this},Lucille.prototype.themes=function(){var a={};return a.plain={},a.plain.background="#e2e2e2",a.plain.touchTargetBackground="#e2e2e2",a.plain.fontColor="#000000",a.plain.chordFontColor="#000000",a.zen={},a.zen.background="#000000",a.zen.touchTargetBackground="#000000",a.zen.fontColor="#FFFFFF",a.zen.fontColor50="#777777",a.zen.chordFontColor="#FF0000",a}(),Lucille.prototype.themeLoad=function(){$(".lucilleTheme").remove();var a=this.themes[this.theme],b="",c=$("<style>");return c.attr("type","text/css"),c.attr("class","lucilleTheme"),b+=".lucille .background { fill: "+a.background+"; }",b+=".lucille .touchTarget { fill: "+a.touchTargetBackground+"; cursor:pointer; }",b+="@font-face {",b+="font-family: 'VarelaRound';",b+="font-style: normal;",b+="font-weight: 400;",b+="src: local('VarelaRound'), local('VarelaRound-Regular'), url(fonts/Varela_Round/VarelaRound-Regular.woff) format('woff');",b+="}",b+=".lucille { font-family:'VarelaRound'; font-size: 1rem; }",b+=".lucille text { alignment-baseline:central; text-anchor:middle; fill:"+a.fontColor+" }",b+=".lucille .buttons .button text { cursor: pointer; fill:"+a.fontColor+"; opacity:0.4; pointer-events:none; }",b+=".lucille .button:hover text { opacity:1; }",b+=".lucille .button.next, .lucille .button.prev, .lucille .button.play { font-family:'FontAwesome'; font-size: 2rem; cursor: pointer; }",b+=".lucille .button.settings, .lucille .button.collapse { font-family:'FontAwesome'; font-size: 1.5rem; cursor: pointer; }",b+=".lucille .chord .root { font-size: 3rem; opacity:1; fill:"+a.chordFontColor+"; pointer-events:none; }",b+=".lucille .chord .type { font-size: 1.10rem; opacity:.4; pointer-events:none; }",b+=".lucille .string{ stroke:"+a.fontColor+"; stroke-width:2; stroke-linecap:round; opacity:0.5; }",b+=".lucille .fret { stroke:"+a.fontColor+"; stroke-width:2; opacity: 0.25; }",b+=".lucille .fret:last-child { opacity: 0; }",b+=".lucille .fretting .string { stroke:"+a.fontColor+"; opacity:1; stroke-width:5; stroke-linecap:round; }",b+=".lucille .fretting .string.disabled { stroke:"+a.fontColor50+"; stroke-width:5; stroke-linecap:round; }",b+=".lucille .fretting .label { font-size:.8rem; opacity:0.6; }",b+=".lucille .fretting .dot { fill:"+a.fontColor+"}",b+=".lucille .fretting .dot.disabled { fill:"+a.fontColor50+"; }",b+=".lucille .minified .title { font-size: 1.15rem; }",b+=".lucille .hide { display: none; }",c.append(b),$("head").append(c),c},Lucille.prototype.configPicker=function(){return{title:"Chord Picker",fields:{root:{name:"root",value:"c_n",enabled:!0,options:{c_n:{name:"C",value:"C"},c_s:{name:"C#",value:"C#"},d_f:{name:"Db",value:"Db"},d_n:{name:"D",value:"D"},d_s:{name:"D#",value:"D#"},e_f:{name:"Eb",value:"Eb"},e_n:{name:"E",value:"E"},f_n:{name:"F",value:"F"},f_s:{name:"F#",value:"F#"},g_b:{name:"Gb",value:"Gb"},g_n:{name:"G",value:"G"},g_s:{name:"G#",value:"G#"},a_f:{name:"Ab",value:"Ab"},a_n:{name:"A",value:"A"},a_s:{name:"A#",value:"A#"},b_b:{name:"Bb",value:"Bb"},b_n:{name:"B",value:"B"}}},type:{name:"type",value:"1",enabled:!0,options:{1:{name:"Major",value:"M"},13:{name:"minor",value:"m"}}}}}},Lucille.prototype.configSettings=function(){var a=this;return{title:"Settings",fields:{orientation:{name:"orientation",value:"righty",enabled:!0,options:{righty:{name:"Right Handed",value:"RIGHTY"},lefty:{name:"Left Handed",value:"LEFTY"}}},tuning:{name:"tuning",value:"standard",enabled:!0,options:{standard:{name:"EADGBE / Standard",value:["e2","a2","d3","g3","b3","e4"]},drop_d:{name:"DADGBE / Drop D",value:["d2","a2","d3","g3","b3","e4"]}}},preview:{name:"preview",value:"gtr_aco_steel",enabled:!0,options:{gtr_aco_steel:{name:"Acoustic Guitar",value:PLUKIT.guitar.acoustic.steel.mp3},gtr_aco_nylon:{name:"Classical Guitar",value:PLUKIT.guitar.acoustic.nylon.mp3},gtr_elec_clean:{name:"Clean Eletric",value:PLUKIT.guitar.electric.clean.mp3},gtr_elec_dist:{name:"Distortion Electric",value:PLUKIT.guitar.electric.dist.mp3}}},"delete":{type:"button",text:"delete",callback:function(){a.destroy()}}}}};