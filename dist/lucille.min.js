var Lucille=function(a){var b={};b.chart={width:320,height:520},b.fretboard={width:120,height:250},b.orientation="RIGHTY",b.instrument=this.Instrument.guitar,b.audio="audio/acoustic_guitar.mp3",b.pattern="strum",b.tab=this.getTab("C","Major",this.Instrument.guitar.tuning),b.theme={},_.extend(this,b,a),this.player=this.getPlayer(),this.themeSetup(),this.render(),this.display()};Lucille.prototype.Fixture=function(){var a={theme:{plain:{background:"#e2e2e2",touchTargetBackground:"#e2e2e2"}},guitar:{root:"C",type:"Major",caged:[0,1],voicings:[[{fret:0,finger:0,note:"E"},{fret:1,finger:0,note:"C"},{fret:0,finger:0,note:"G"},{fret:2,finger:0,note:"E"},{fret:3,finger:0,note:"C"},{fret:null,finger:null,note:null}],[{fret:3,finger:0,note:"G"},{fret:5,finger:0,note:"D"},{fret:5,finger:0,note:"C"},{fret:5,finger:0,note:"G"},{fret:3,finger:0,note:"C"},{fret:3,finger:0,note:"G"}]]}};return a}(),Lucille.prototype.Instrument=function(){var a={guitar:{strings:6,tuning:["e2","a2","d3","g3","b3","e4"]},guitar_drop_d:{strings:6,tuning:["d2","a2","d3","g3","b3","e4"]},mandolin:{strings:4,tuning:["g3","d4","a4","e5"]},banjo_4_string:{strings:4,tuning:[]},banjo_5_string:{strings:5,tuning:[]}};return a}(),Lucille.prototype.calcVoicing=function(){return this.tab.voicings[this.tab.caged[0]]},Lucille.prototype.calcLayout=function(){var a={};return a.chart=this.chart,a.fretboard=this.fretboard,a.strings=this.calcStringLayout(),a.frets=this.calcFretLayout(),a},Lucille.prototype.calcStringLayout=function(){for(var a=this,b=this.instrument.strings,c=this.fretboard.width/(b-1),d=.025*this.fretboard.height,e=_.times(b,function(a){return a*c}),f=_.times(b,function(a){return a*c}),g=_.times(b,function(){return 0}),h=_.times(b,function(){return a.fretboard.height}),i=0,j=0,k=b-1;k>=j;j++,k--)g[j]=i,g[k]=i,i+=d;return"RIGHTY"===this.orientation&&(e.reverse(),f.reverse(),g.reverse(),h.reverse()),{x1:e,x2:f,y1:g,y2:h,spacing:c}},Lucille.prototype.calcFretLayout=function(){var a,b,c=this.calcVoicing(),d=null;return a=_.sortBy(c,function(a){return a.fret}),a=_.pluck(a,"fret"),a=_.compact(a),a=_.range(_.first(a),_.last(a)+1),b=this.fretboard.height/a.length,d=_.times(a.length,function(a){return(a+1)*b}),{y:d,range:a,spacing:b}},Lucille.prototype.calcSpriteOffsets=function(){var a=["c","c#/db","d","d#/eb","e","f","f#/gb","g","g#/ab","a","a#/bb","b"],b=0,c={},d=4e3,e=5;return _.times(e,function(e){var f=e+2;_.each(a,function(a){var e=a.split("/");c[e[0]+f]=[b,d],e.length>1&&(c[e[1]+f]=[b,d]),b+=d})}),c},Lucille.prototype.render=function(){this.svg=Snap(this.chart.width,this.chart.height).attr("class","lucille"),this.lucille=this.renderContainer(),this.lucille.background=this.renderBackground(),this.lucille.chord=this.renderChord(),this.lucille.fretboard=this.renderFretboard(),this.lucille.strings=this.renderStrings(),this.lucille.frets=this.renderFrets(),this.lucille.frettings=this.renderFrettings(),this.lucille.buttons=this.renderButtons(),this.lucille.settings=this.renderSettings(),this.lucille.picker=this.renderPicker(),this.lucille.minified=this.renderMinified(),this.lucille.minified.background=this.renderMinifiedBackground(),this.lucille.minified.buttons=this.renderMinifiedButtons(),this.lucille.minified.title=this.renderMinifiedTitle()},Lucille.prototype.renderContainer=function(){var a=this.svg.g();return a.attr({"class":"main"}),a},Lucille.prototype.renderBackground=function(){var a=this,b=this.lucille.rect(0,0,this.chart.width,this.chart.height);b.attr({"class":"background"});var c=new Hammer(b.node,{distance:100,velocity:.5});return c.on("swipe",function(b){var c=2===b.direction?"up":"down";a.play(c)}),b},Lucille.prototype.renderChord=function(){{var a=(this.chart.width-100)/2,b=10,c=this.lucille.g().attr({"class":"chord button",transform:"translate("+a+","+b+")"});c.rect(0,0,100,100).attr("class","touchTarget"),c.text(50,50,this.tab.root).attr("class","root"),c.text(50,90,this.tab.type).attr("class","type")}return c.click(function(){this.lucille.picker.display()},this),c},Lucille.prototype.renderFretboard=function(){var a=this.calcLayout(),b=this.lucille.g(),c=(a.chart.width-a.fretboard.width)/2,d=(a.chart.height-a.fretboard.height)/2+15;return b.attr({"class":"fretboard",transform:"translate("+c+","+d+")"}),b},Lucille.prototype.renderFretboardRefresh=function(){this.lucille.fretboard.clear(),this.lucille.strings=this.renderStrings(),this.lucille.frets=this.renderFrets(),this.lucille.frettings=this.renderFrettings()},Lucille.prototype.renderStrings=function(){var a=this.calcLayout(),b=this.lucille.fretboard.g().attr("class","strings");return _.times(a.strings.x1.length,function(c){var d=a.strings.x1[c],e=a.strings.x2[c],f=a.strings.y1[c],g=a.strings.y2[c],h=b.line(d,f,e,g);h.attr({"class":"string"})}),b.selectAll(".string")},Lucille.prototype.renderFrets=function(){var a=null!==this.lucille.fretboard.select(".frets"),b=this.calcLayout(),c=!0===a?this.lucille.fretboard.select(".frets"):this.lucille.fretboard.g().attr("class","frets");return c.clear(),_.each(b.frets.y,function(a){var d=c.line(0,a,b.fretboard.width,a);d.attr({"class":"fret"})}),c.selectAll(".fret")},Lucille.prototype.renderFrettings=function(){var a=this,b=this.calcLayout(),c=this.lucille.fretboard.g().attr("class","frettings"),d=11,e=this.calcVoicing();return _.times(b.strings.x1.length,function(f){{var g=b.strings.x1[f],h=b.fretboard.height/2,i=c.g().attr({"class":"fretting"}),j=(i.circle(g,h,d).attr("class","dot"),i.line(g,h,g,a.fretboard.height).attr("class","string"),b.strings.y1[f]-15),k=null===e[f].fret?"X":e[f].fret.toString(),l=(i.text(g,j,k).attr("class","tab label"),b.strings.y2[f]+15),m=null===e[f].note?"X":e[f].note;i.text(g,l,m).attr("class","note label")}i.click(function(){a.playString(f)},this)}),c.selectAll(".fretting")},Lucille.prototype.renderButtons=function(){var a=this,b=this.calcLayout(),c=this.lucille.g().attr("class","buttons"),d=b.chart.width-(b.chart.width-b.fretboard.width)/2/2,e=b.chart.height/2,f=c.g(),g=(f.rect(-25,-25,50,50).attr({"class":"touchTarget"}),f.text(0,0,""));f.click(this.displayNext,this),f.attr({"class":"button next",transform:"translate("+d+","+e+")"}),g.node.innerHTML="&#xf054";var h=(b.chart.width-b.fretboard.width)/2/2,i=b.chart.height/2,j=c.g(),k=(j.rect(-25,-25,50,50).attr("class","touchTarget"),j.text(0,0,""));j.click(this.displayPrev,this),j.attr({"class":"button prev",transform:"translate("+h+","+i+")"}),k.node.innerHTML="&#xf053";var l=b.chart.width/2,m=b.chart.height-(b.chart.height-b.fretboard.height)/2/2+10,n=c.g(),o=(n.rect(-25,-25,50,50).attr("class","touchTarget"),n.text(0,0,""));n.click(function(){a.play()},this),n.attr({"class":"button play",transform:"translate("+l+","+m+")"}),o.node.innerHTML="&#xf028";var p=b.chart.width-(b.chart.width-b.fretboard.width)/2/2,q=(b.chart.width-b.fretboard.width)/2/2,r=c.g(),s=(r.rect(-25,-25,50,50).attr("class","touchTarget"),r.text(0,0,""));r.click(function(){this.lucille.settings.display()},this),r.attr({"class":"button settings",transform:"translate("+p+","+q+")"}),s.node.innerHTML="&#xf0c9";var t=(b.chart.width-b.fretboard.width)/2/2,u=(b.chart.width-b.fretboard.width)/2/2,v=c.g(),w=(v.rect(-25,-25,50,50).attr("class","touchTarget"),v.text(0,0,""));return v.click(this.displayMinified,this),v.attr({"class":"button collapse",transform:"translate("+t+","+u+")"}),w.node.innerHTML="&#xf068",c.selectAll(".button")},Lucille.prototype.renderSettings=function(){var a={};a.name="orientation",a.values=["RIGHTY","LEFTY"],a.selected=0;var b={};b.name="instrument",b.values=["Guitar","Mandolin"],b.selected=0;var c={};c.name="preview",c.values=["Strum","Arpeggiate","Travis Pick"],c.selected=0;var d={};d.title="settings",d.colors={background:"#e2e2e2"},d.fields=[a,b,c];var e=this,f=function(a){e.updateSettings(a)},g=this.lucille.g(),h=new Pickl({svg:g,callback:f,config:d});return h},Lucille.prototype.renderPicker=function(){var a={};a.name="root",a.values=["C","C#/Db","D","D#/Eb","E","F","F#/Gb","G","G#/Ab","A","A#/Bb","B"],a.selected=0;var b={};b.name="type",b.values=["Major","minor"],b.selected=0;var c={};c.title="Chord",c.colors={background:"#e2e2e2"},c.fields=[a,b];var d=this,e=function(a){d.updateChord(a)},f=this.lucille.g(),g=new Pickl({svg:f,callback:e,config:c});return g},Lucille.prototype.renderMinified=function(){var a=this.svg.g();return a.attr({"class":"minified",display:"none"}),a},Lucille.prototype.renderMinifiedBackground=function(){var a=this.lucille.minified.rect(0,0,this.chart.width,50);return a.attr({"class":"background"}),a},Lucille.prototype.renderMinifiedButtons=function(){var a,b,c,d,e,f=this,g=this.calcLayout(),h=null;return a=25,b=25,c=this.lucille.minified.g().attr("class","buttons"),d=c.g(),e=d.rect(-25,-25,50,50).attr("class","touchTarget"),h=d.text(0,0,""),d.click(this.displayMinifiedHidden,this),d.attr({"class":"button collapse",transform:"translate("+a+","+b+")"}),h.node.innerHTML="&#xf067",a=g.chart.width-25,b=25,c=this.lucille.minified.g().attr("class","buttons"),d=c.g(),e=d.rect(-25,-25,50,50).attr("class","touchTarget"),h=d.text(0,0,""),d.click(function(){f.play()},this),d.attr({"class":"button collapse",transform:"translate("+a+","+b+")"}),h.node.innerHTML="&#xf028",c},Lucille.prototype.renderMinifiedTitle=function(){var a=(this.calcLayout(),this.chart.width/2),b=25,c=this.tab.root,d=this.tab.type,e=c+" "+d,f=this.lucille.minified.text(a,b,e).attr({"class":"title"});return f},Lucille.prototype.display=function(){var a=this.calcVoicing(),b=this.calcLayout(),c=b.frets,d=this.lucille.frettings;this.renderFrets(),_.each(a,function(a,e){var f=d[e],g=_.indexOf(c.range,a.fret),h=-1===g?0:g,i=f.select(".dot"),j=-1===g?"dot hide":"dot",k=c.y[h]-c.spacing/2;i.attr({"class":j}),i.animate({cy:k},700,mina.backout);var l=f.select(".string"),m=null===a.fret?"string hide":"string",n=0===a.fret?b.strings.y1[e]:c.y[h]-c.spacing/2;l.attr({"class":m}),l.animate({y1:n},700,mina.backout);var o=f.select(".tab"),p=null===a.fret?"X":a.fret;o.node.textContent=p;var q=f.select(".note"),r=null===a.note?"X":a.note;q.node.textContent=r})},Lucille.prototype.displayNext=function(){var a=this.tab.caged[0],b=this.tab.caged[1],c=a+1>b?0:a+1;this.tab.caged[0]=c,this.display()},Lucille.prototype.displayPrev=function(){var a=this.tab.caged[0],b=this.tab.caged[1],c=0>a-1?b:a-1;this.tab.caged[0]=c,this.display()},Lucille.prototype.displayOrientation=function(a){this.orientation=a,this.renderFretboardRefresh(),this.display()},Lucille.prototype.displayMinified=function(){this.lucille.minified.attr("display",""),this.lucille.attr("display","none"),this.svg.attr("height",50)},Lucille.prototype.displayMinifiedHidden=function(){this.lucille.minified.attr("display","none"),this.lucille.attr("display",""),this.svg.attr("height",this.chart.height)},Lucille.prototype.play=function(a){var b=this,c=_.map(this.calcVoicing(),function(a){return a.note}),a=(_.map(this.getCurrentVoicing(),function(a){return a.obj.key()}),_.map(this.getCurrentVoicing(),function(a){return a.obj.toString()}),this.calcSpriteOffsets(),a||"down"),d="down"===a?_.eachRight:_.each,e=65;d(c,function(a,c){null!==a&&(window.setTimeout(function(){b.playString(c)},e),e+=65)})},Lucille.prototype.playString=function(a){var b=this.lucille.frettings[a].select(".string"),c=b.attr("x1"),d=1,e=5,f=(_.map(this.getCurrentVoicing(),function(a){return a.obj.key()})[a],_.map(this.getCurrentVoicing(),function(a){return a.obj.toString()})[a]);this.player.play(f),void 0===b.data("active")&&b.data("active",!1);var g=function(a){var e=c,f=parseInt(c)+a,g=parseInt(c)-a;b.data("active",!0),e=1==d?f:g,b.attr({x1:e,x2:e}),d=1==d?0:1},h=function(){b.attr({x1:c,x2:c}),b.data("active",!1)};!1===b.data("active")&&Snap.animate(e,1,g,200*e,mina.easein,h)},Lucille.prototype.updateSettings=function(a){this.orientation=a.orientation,this.instrument=this.getInstrument(a.instrument),this.tab=this.getTab(this.tab.root,this.tab.type,this.instrument.tuning),this.renderFretboardRefresh(),this.display()},Lucille.prototype.updateChord=function(a){this.updateRootText(a.root),this.updateTypeText(a.type),this.updateMinifiedTitle(a.root,a.type),this.tab=this.getTab(a.root,a.type,this.instrument.tuning),this.renderFretboardRefresh(),this.display()},Lucille.prototype.updateRootText=function(a){this.lucille.chord.select(".root").node.textContent=a},Lucille.prototype.updateTypeText=function(a){this.lucille.chord.select(".type").node.textContent=a},Lucille.prototype.updateMinifiedTitle=function(a,b){this.lucille.minified.title.node.textContent=a+" "+b},Lucille.prototype.transToTabulousChordType=function(a){var b="";switch(a){case"Major":b="";break;case"minor":b="m"}return b},Lucille.prototype.transTabulousChordToVoicings=function(a){var b=_.map(a.voicings,function(a){return _.map(a.data,function(b,c){return{fret:a.voicing[c],finger:0,note:b.toString(!0).charAt(0).toUpperCase()+b.toString(!0).charAt(1),obj:b}})});return b=_.map(b,function(a){return a.reverse()})},Lucille.prototype.getTab=function(a,b,c){var c=c||this.instrument.tuning,d=new Tabulous({root:a.toLowerCase(),type:this.transToTabulousChordType(b),tuning:c}),e=this.transTabulousChordToVoicings(d),f={root:a,type:b,caged:[0,e.length-1],voicings:e};return f},Lucille.prototype.getCurrentVoicing=function(){return this.tab.voicings[this.tab.caged[0]]},Lucille.prototype.getInstrument=function(a){var b=null;switch(a){case"Guitar":b=this.Instrument.guitar;break;case"Mandolin":b=this.Instrument.mandolin}return b},Lucille.prototype.getPlayer=function(){var a=new Howl({urls:[this.audio],sprite:this.calcSpriteOffsets()});return a},Lucille.prototype.themeSetup=function(){var a={};a.background="#e2e2e2",a.touchTargetBackground="#e2e2e2",a.fontColor="#000000",a.chordFontColor="#000000";var b=_.extend(a,this.theme);return this.themeLoad(b),b},Lucille.prototype.themeLoad=function(a){$(".lucilleTheme").remove();var b="",c=$("<style>");return c.attr("type","text/css"),c.attr("class","lucilleTheme"),b+=".lucille .background { fill: "+a.background+"; }",b+=".lucille .touchTarget { fill: "+a.touchTargetBackground+"; }",b+="@font-face {",b+="font-family: 'VarelaRound';",b+="font-style: normal;",b+="font-weight: 400;",b+="src: local('VarelaRound'), local('VarelaRound-Regular'), url(../fonts/Varela_Round/VarelaRound-Regular.woff) format('woff');",b+="}",b+=".lucille { font-family:'VarelaRound'; font-size: 1rem; }",b+=".lucille text { alignment-baseline:central; text-anchor:middle; fill:"+a.fontColor+" }",b+=".lucille .button text { cursor: pointer; fill:"+a.fontColor+"; opacity:0.4; }",b+=".lucille .button:hover text { opacity:1; }",b+=".lucille .button.next, .lucille .button.prev, .lucille .button.play { font-family:'FontAwesome'; font-size: 2rem; cursor: pointer; }",b+=".lucille .button.settings, .lucille .button.collapse { font-family:'FontAwesome'; font-size: 1.5rem; cursor: pointer; }",b+=".lucille .chord .root { font-size: 3rem; opacity:1; fill:"+a.chordFontColor+" }",b+=".lucille .chord .type { font-size: 1.10rem; }",b+=".lucille .string{ stroke:"+a.fontColor+"; stroke-width:2; stroke-linecap:round; opacity:0.5; }",b+=".lucille .fret { stroke:"+a.fontColor+"; stroke-width:2; opacity: 0.25; }",b+=".lucille .fret:last-child { opacity: 0; }",b+=".lucille .fretting .string { stroke:"+a.fontColor+"; opacity:1; stroke-width:5; stroke-linecap:round; }",b+=".lucille .fretting .label { font-size:.8rem; opacity:0.6; }",b+=".lucille .fretting .dot { fill:"+a.fontColor+"}",b+=".lucille .minified .title { font-size: 1.15rem; }",b+=".lucille .hide { display: none; }",c.append(b),$("head").append(c),c};