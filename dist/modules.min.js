var Pickl=function(a){var b={};b.form={width:320,height:520},b.config=this.Config,b.theme="zen",b.svg=null,b.callback=function(a){console.log(a)},_.extend(this,b,a),this.themeLoad(),this.render()};Pickl.prototype.Config=function(){return{title:"Options",fields:{remove:{type:"button",text:"Remove",callback:function(){alert("delete")}},order_test:{name:"order",value:"two",enabled:!0,options:{two:{name:"two",value:"two"},1:{name:"1",value:"1"}}},orientation:{name:"orientation",value:"righty",enabled:!0,callback:null,options:{righty:{name:"righty",value:"RIGHTY"},lefty:{name:"lefty",value:"LEFTY"}}},root:{name:"root",value:"c_n",enabled:!0,options:{c_n:{name:"C",value:"C"},c_s:{name:"C#",value:"C#"},d_f:{name:"Db",value:"Db"},d_n:{name:"D",value:"D"},d_s:{name:"D#",value:"D#"},e_f:{name:"Eb",value:"Eb"},e_n:{name:"E",value:"E"},f_n:{name:"F",value:"F"},f_s:{name:"F#",value:"F#"},g_b:{name:"Gb",value:"Gb"},g_n:{name:"G",value:"G"},g_s:{name:"G#",value:"G#"},a_f:{name:"Ab",value:"Ab"},a_n:{name:"A",value:"A"},a_s:{name:"A#",value:"A#"},b_b:{name:"Bb",value:"Bb"},b_n:{name:"B",value:"B"}}},instrument:{name:"instrument",value:"guitar",enabled:!0,callback:null,options:{guitar:{name:"guitar",value:"GUITAR",enable:"tuning_guitar",disable:"tuning_banjo"},banjo:{name:"banjo",value:"BANJO",disable:"tuning_guitar",enable:"tuning_banjo"}}},tuning_guitar:{name:"tuning",value:"standard",enabled:!0,options:{standard:{name:"standard",value:"EADGBE"},drop_d:{name:"drop d",value:"DADGBE"}}},tuning_banjo:{name:"tuning",value:"standard",enabled:!1,options:{standard:{name:"standard",value:"EADG"},drop_d:{name:"drop d",value:"DADG"}}}}}}(),Pickl.prototype.render=function(){this.pickl=this.pickl||this.renderForm(),this.pickl.clear(),this.pickl.background=this.renderBackground(),this.pickl.title=this.renderTitle(),this.pickl.fields=this.renderFields()},Pickl.prototype.renderForm=function(){var a=null===this.svg?Snap(this.form.width,this.form.height):this.svg,b=a.attr("class")+" pickl";return a.attr({class:b,transform:"translate("+this.form.width+",0)"}),a},Pickl.prototype.renderBackground=function(){var a=this.pickl.rect(0,0,this.form.width,this.form.height);return a.attr({class:"background"}),a},Pickl.prototype.renderTitle=function(){var a=this.pickl.text(this.form.width/2,50,this.config.title);return a.attr({class:"title"}),a},Pickl.prototype.renderFields=function(){var a=this,b=this.calcLayout().fields,c=this.pickl.g().attr("class","fields"),d=90;_.each(this.config.fields,function(e){if(e.enabled){var f=c.g().attr({class:"field button",transform:"translate("+b.x+","+d+")"});f.rect(0,0,b.width,40).attr({class:"touchTarget"}),f.text(b.x+70,20,e.name).attr({class:"title"}),f.text(b.x+80,20,e.options[e.value].name).attr("class","value");d+=41;var g=void 0===e.callback||null===e.callback?function(){a.displayOptions(e)}:e.callback;f.click(g,a)}if("button"===e.type){var f=c.g().attr({class:"field button",transform:"translate("+b.x+","+d+")"});f.rect(0,0,b.width,40).attr({class:"touchTarget"}),f.text(b.width/2,20,e.text).attr({class:"text"});d+=41,f.click(e.callback,a)}});var e=this.pickl.g().attr({class:"button close",transform:"translate("+b.x+","+(d+20)+")"}),f=.85*this.form.width,g=50;e.rect(0,0,f,g).attr({class:"touchTarget"}),e.text(b.width/2,25,"done");return e.click(this.save,this),c.selectAll(".field")},Pickl.prototype.renderOptions=function(a){var b=this,c=b.calcLayout().fields,d=this.pickl.g().attr({class:"options"}),e=(d.rect(0,0,b.form.width,b.form.height).attr("class","background"),b.form.height-140),f=40*_.size(a.options)>e,g=Math.floor(e/40),h=f?e/g:40,i=d.rect(c.x,50,c.width,e+g).attr({fill:"#FFFFFF"}),j=d.mask().add(i).attr({class:"mask"}),k=d.g().attr({class:"fields",mask:j}),l=k.g().data("y",0),m=a.options[a.value].value,n=0,o=50,p=c.x-1;d.attr({transform:"translate("+this.form.width+",0)"});var q=1;_.each(a.options,function(e,f){var g=l.g().attr({class:"field button",transform:"translate("+p+","+o+")"}),i=(g.rect(0,0,c.width,h).attr({class:"touchTarget"}),g.text(h,h/2,e.name).attr({class:"value"}),e.value===m?"check selected":"check"),j=g.g().attr({class:i});j.rect(0,0,h,h).attr({class:"touchTarget"}),j.text(h/4,h/2,"").attr({class:"value"});e.value===m&&(n=q),q+=1,o+=h+1,g.click(function(){a.value=f,d.animate({transform:"translate("+this.form.width+",0)"},200,mina.easeout,function(){this.remove()}),_.each(e.disable,function(a){b.displayField(a,!1)}),_.each(e.enable,function(a){b.displayField(a,!0)}),b.render()},b)});var r=(d.rect(0,0,b.form.width,50).attr({class:"background"}),d.text(b.form.width/2,27,a.name).attr("class","title options"),d.rect(0,e+g+50,b.form.width,90).attr({class:"background"}),this.form.height-70),s=!0===f?"":"hide",t=d.g().attr({class:"field button scroll "+s,transform:"translate("+this.form.width/2+","+r+")"}),u=!0,v=(t.rect(0,0,c.width/2-2,h).attr({class:"touchTarget"}),t.text(c.width/4,h/2,"").attr({class:"value"}),d.g().attr({class:"field button scroll "+s,transform:"translate("+c.x+","+r+")"})),w=(v.rect(0,0,c.width/2-2,h).attr({class:"touchTarget"}),v.text(c.width/4,h/2,"").attr({class:"value"}),function(){u=!0,y()}),x=function(){u=!1},y=function(){var b=l.data("y")-(h+1),c=-(_.size(a.options)-g)*(h+1);Math.ceil(b)>=c&&(l.animate({transform:"translate(0,"+b+")"},100,mina.easeout,function(){u&&y()}),l.data("y",b))},z=function(){u=!0,A()},A=function(){var a=l.data("y")+(h+1);Math.floor(a)<=0&&(l.animate({transform:"translate(0,"+a+")"},100,mina.easeout,function(){u&&A()}),l.data("y",a))};if(t.mousedown(w),t.mouseup(x),v.mousedown(z),v.mouseup(x),n>g){var o=-(n-g)*(h+1);l.attr({transform:"translate(0,"+o+")"}),l.data("y",o)}return d},Pickl.prototype.calcLayout=function(){var a={};return a.fields=this.calcFields(),a},Pickl.prototype.calcFields=function(){return{height:40,width:.85*this.form.width,x:.15*this.form.width/2}},Pickl.prototype.display=function(){this.pickl.animate({transform:"translate(0,0)"},200,mina.easein)},Pickl.prototype.displayOptions=function(a){this.renderOptions(a).animate({transform:"translate(0,0)"},200,mina.easin)},Pickl.prototype.displayField=function(a,b){var c=this,a="string"==typeof a?[a]:a;_.each(a,function(a){void 0!==c.config.fields[a]&&(c.config.fields[a].enabled=b)})},Pickl.prototype.save=function(){var a={};_.each(this.config.fields,function(b){b.enabled&&(a[b.name]=b.options[b.value])}),this.callback(a),this.pickl.animate({transform:"translate("+this.form.width+",0)"},200,mina.easein)},Pickl.prototype.themes=function(){var a={};return a.plain={},a.plain.background="#e2e2e2",a.plain.fieldset="#666666",a.plain.touchTarget="#f2f2f2",a.plain.touchTargetOver="#000000",a.plain.buttonTextColor="#999999",a.plain.buttonTextColorOver="#e2e2e2",a.plain.buttonStroke="#e2e2e2",a.plain.modalBackground="#f2f2f2",a.zen={},a.zen.background="#000000",a.zen.fieldset="#666666",a.zen.touchTarget="#222222",a.zen.touchTargetOver="#444444",a.zen.titleColor="#FFFFFF",a.zen.buttonTextColor="#999999",a.zen.buttonTextColorOver="#FFFFFF",a.zen.buttonStroke="",a.zen.modalBackground="#000000",a}(),Pickl.prototype.themeLoad=function(){var a=this.themes[this.theme];$(".picklTheme").remove();var b="",c=$("<style>");return c.attr("type","text/css"),c.attr("class","picklTheme"),b+="@font-face {",b+="font-family: 'VarelaRound';",b+="font-style: normal;",b+="font-weight: 400;",b+="src: local('VarelaRound'), local('VarelaRound-Regular'), url(fonts/Varela_Round/VarelaRound-Regular.woff) format('woff');",b+="}",b+=".pickl { font-family:'VarelaRound'; font-size: 1rem; }",b+=".pickl .title { text-transform: uppercase; font-size: 1.5rem; }",b+=".pickl .title.options { font-size: .7rem; opacity: 0.5; }",b+=".pickl .hide { display: none; }",b+=".pickl text { alignment-baseline:central; text-anchor:middle; pointer-events:none; }",b+=".pickl .button { cursor: pointer; font-size: 0.85rem; }",b+=".pickl .button.close { text-transform: uppercase; }",b+=".pickl .button.arrow .touchTarget { stroke:none; }",b+=".pickl .field { font-size: 0.85rem; }",b+=".pickl .field .title { font-size: .7rem; opacity: 0.5; text-anchor: end; }",b+=".pickl .field .value { text-anchor:start; }",b+=".pickl .field .check { font-family:'FontAwesome'; font-size: 1.25rem; text-anchor:middle; opacity: .2; cursor: pointer; }",b+=".pickl .scroll { font-family:'FontAwesome'; font-size: 1.25rem; text-anchor:middle; opacity: .8; cursor: pointer; }",b+=".pickl .scroll .value { text-anchor:middle; }",b+=".pickl .field .check.selected, .pickl .field:hover .check, .pickl .scroll:hover { opacity: 1; }",b+=".pickl .background { fill: "+a.background+"; } ",b+=".pickl .fieldset { fill: "+a.fieldset+"; } ",b+=".pickl .title { fill: "+a.titleColor+";} ",b+=".pickl .field text, .close text { fill:"+a.buttonTextColor+"} ",b+=".pickl .button > .touchTarget, .pickl .field .touchTarget { fill: "+a.touchTarget+"; } ",b+=".pickl .button > .touchTarget { stroke: "+a.buttonStroke+"; } ",b+=".pickl .button:hover .touchTarget { fill: "+a.touchTargetOver+"; cursor:pointer; } ",b+=".pickl .button:hover text { fill: "+a.buttonTextColorOver+"; } ",b+=".pickl .button > .arrow > .touchTarget { fill: "+a.touchTarget+" } ",c.append(b),$("head").append(c),c};var Tabulous=function(a){var b={};b.root="C",b.type="",b.tuning=["e2","a2","d3","g3","b3","e4"],b.frets=24,b.span=5,b.algorithm="KORDFU",this.settings=_.extend({},b,a),this.setUp()};Tabulous.prototype.getTuning=function(){var a=function(a){return teoria.note(a)};return _.map(this.settings.tuning,a)},Tabulous.prototype.getBoard=function(){var a=this.tuning,b=[];return _.times(this.settings.frets,function(c){b[c]=[],_.each(a,function(a,d){var e=teoria.note.fromKey(a.key()+c);b[c][d]=e})}),b},Tabulous.prototype.getChord=function(){return teoria.chord(this.settings.root+this.settings.type)},Tabulous.prototype.getNotes=function(a){return this.chord.notes()},Tabulous.prototype.getVoicings=function(){var a=this.calcAllPossibleVoicings(),b=this.filterDupVoicings(a),c=this.assignData(b),d=this.assignDataLabels(c),e=this.filterPlayableChords(d);return this.filterChordType(e)},Tabulous.prototype.setUp=function(){this.tuning=this.getTuning(),this.board=this.getBoard(),this.chord=this.getChord(),this.notes=this.getNotes(),this.voicings=this.getVoicings()},Tabulous.prototype.set=function(a,b){this.settings[a]=b,this.setUp()},Tabulous.prototype.setNoteLabels=function(a){var b=this;this.notes.length,b.settings.root.toLowerCase();return a},Tabulous.prototype.printBoard=function(){var a=$("<pre>");return $("body").append(a),a.append("<h2>Board</h2>"),_.each(this.board,function(b,c){_.each(b,function(c,d){var e=b[d].enharmonics().length;if(e>0)if(e>1)var f="/"+b[d].enharmonics()[0].toString()+"/"+b[d].enharmonics()[1].toString();else var f="/"+b[d].enharmonics()[0].toString()+"/";else var f="";a.append(b[d].toString()+f+"\t")}),a.append("<br/>")}),_.each(this.board,function(a,b){_.each(a,function(c,d){var e=a[d].enharmonics().length?a[d].enharmonics().toString():"x";console.log("string-"+b,"fret-"+d,"note-"+a[d].toString(),"enharm-"+e,"key-"+a[d].key(),"freq-"+a[d].fq())})}),null},Tabulous.prototype.printBoardChordNotes=function(){var a=$("<table border=1>"),b=_.map(this.notes,function(a){return a.name()+a.accidental()});$("body").append(a),a.append("<h2>Tab</h2>"),_.each(this.board,function(c,d){var e=$("<tr>");a.append(e),e.append("<td>"+d+"</td>"),_.each(c,function(a,d){var f=c[d],g="",h="",i="";f.enharmonics().length&&(g+=f.enharmonics()[0].toString(!0),h=f.enharmonics()[0].toString(!0),2===f.enharmonics().length&&(g+="/"+f.enharmonics()[1].toString(!0),i=f.enharmonics()[1].toString(!0)));var j=f.name()+f.accidental(),k=_.contains(b,j)||_.contains(b,h)||_.contains(b,i),l=!0===k?j+"/"+g:"*";e.append("<td>"+l+"</td>")})})},Tabulous.prototype.printVoicings=function(a){var a=a||this.voicings;console.log("chord=",this.chord),console.log("tuning=",this.tuning),console.log("notes=",this.notes),_.each(a,function(a){_.each(a.data,function(a,b){}),console.log(a.voicing,a)})},Tabulous.prototype.calcAllPossibleCombinations=function(a){var b=_.reduce(a,function(a,b){return _.flatten(_.map(a,function(a){return _.map(b,function(b){return a+"|"+b})}),!1)});return _.map(b,function(a){return _.map(a.split("|"),function(a){return isNaN(a)?a:parseInt(a)})})},Tabulous.prototype.calcAllPossibleVoicings=function(a,b){var b=b||[],a=a||0,c=_.range(a,a+this.settings.span),d=_.map(this.notes,function(a){return a.name()+a.accidental()}),e=this.tuning,f=[];_.each(e,function(a){var b=[];_.each(c,function(c){var e=teoria.note.fromKey(a.key()+c),f=e.enharmonics().length?e.enharmonics()[0].toString(!0):"",g=e.enharmonics().length>1?e.enharmonics()[1].toString(!0):"",h=e.toString(!0);(_.contains(d,h)||_.contains(d,f)||_.contains(d,g))&&b.push(c)}),f.push(b)}),_.each(f,function(a){0===a.length&&a.push("X")});var g=this.calcAllPossibleCombinations(f),h=a+1,i=a+this.settings.span<this.settings.frets;return _.each(g,function(a){b.push(a)}),!0===i?this.calcAllPossibleVoicings(h,b):b},Tabulous.prototype.filterPlayableChords=function(a){var b=[];return _.each(a,function(a,c){var d=a.voicing,e=0,f=[],g=_.contains(d,0),h=_.filter(d,function(b,c){return b>0&&a.data[c].active}),i=_.sortBy(h)[0],j=d.slice(0);_.each(j,function(a,b){var c=(_.contains([0,-1],a),_.filter(h,function(b){return b===a}).length);_.contains(f,a)||(g||i!==a||(e+=1),g&&i===a&&(e+=c),i!==a&&(e+=c)),f.push(a)}),e<=4&&b.push(a)}),b},Tabulous.prototype.filterChordType=function(a){var b=(_.map(this.notes,function(a){return a.toString(!0)}),_.map(this.notes,function(a){return a.chroma()})),c=function(a){var c=function(a){return a.teoria.chroma()},c=_.map(a.data,c),d=function(a){return a.teoria.toString(!0)},d=_.map(a.data,d);return 0===_.difference(b,c).length};return _.filter(a,c)},Tabulous.prototype.filterDupVoicings=function(a){var b=[],c=[];return _.each(a,function(a){void 0===_.find(b,a)&&(b.push(a),c.push(a))}),c},Tabulous.prototype.assignData=function(a){var b=this.board,c=[];this.settings.root.toLowerCase();return _.each(a,function(a){var d={};d.voicing=a,d.data=_.map(a,function(a,c){if("X"===a)var d=null;else var d=b[a][c];return d}),c.push(d)}),c},Tabulous.prototype.assignDataLabels=function(a){var b=this,c=this.notes.length,d=this.tuning.length,e=b.settings.root.toLowerCase();return _.each(a,function(a){var b=_.findIndex(a.data,function(a){return a.toString(!0)===e});a.data=_.map(a.data,function(a,f){var g=f>=b||f>=d-c;return{teoria:a,isRoot:e===a.toString(!0),isActive:g}})}),a};var PLUKIT={guitar:{acoustic:{nylon:{mp3:"gtr_aco_nylon.mp3"},steel:{mp3:"gtr_aco_steel.mp3"}},electric:{clean:{mp3:"gtr_elec_clean.mp3"},dist:{mp3:"gtr_elec_dist.mp3"}}}},Plukit=function(a){var b={};b.sampleFile=PLUKIT.guitar.acoustic.steel.mp3,b.samplePath="modules/plukit/",b.sampleLength=2e3,b.device="undefined"==typeof device?"browser":device.platform,this.settings=_.extend(this,b,a),this.spriteOffsets=this.calcSpriteOffsets(),this.player=this.getPlayer()};Plukit.prototype.getPlayer=function(){switch(this.settings.device){case"browser":return this.getHowler()}},Plukit.prototype.getHowler=function(){return new Howl({urls:[this.settings.samplePath+this.settings.sampleFile],sprite:this.settings.spriteOffsets})},Plukit.prototype.calcSpriteOffsets=function(){var a=this,b=["c","c#/db","d","d#/eb","e","f","f#/gb","g","g#/ab","a","a#/bb","b"],c=0,d={};return _.times(5,function(e){var f=e+1;_.each(b,function(b){var e=b.split("/");d[e[0]+f]=[c,a.settings.sampleLength],e.length>1&&(d[e[1]+f]=[c,a.settings.sampleLength]),c+=a.settings.sampleLength})}),d},Plukit.prototype.play=function(a){switch(this.settings.device){case"browser":this.player.play(a);break;case"Android":var b=function(){},c=function(){},d=this.settings.samplePath+this.settings.sampleFile,e=new Media(d,b,c),f=this.spriteOffsets[a][0],g=function(){e.pause(),e.release()};e.seekTo(f),e.play(),window.setTimeout(g,1e3)}};