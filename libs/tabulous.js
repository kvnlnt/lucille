var Tabulous=function(a){var b={};b.root="C",b.type="",b.tuning=["e2","a2","d3","g3","b3","e4"],b.frets=24,b.span=5,b.algorithm="KORDFU",this.settings=_.extend({},b,a),this.setUp()};Tabulous.prototype.getTuning=function(){var a=function(a){return teoria.note(a)},b=_.map(this.settings.tuning,a);return b},Tabulous.prototype.getBoard=function(){var a=this.tuning,b=[];return _.times(this.settings.frets,function(c){b[c]=[],_.each(a,function(a,d){var e=teoria.note.fromKey(a.key()+c);b[c][d]=e})}),b},Tabulous.prototype.getChord=function(){var a=teoria.chord(this.settings.root+this.settings.type);return a},Tabulous.prototype.getNotes=function(){var a=this.chord.notes();return a},Tabulous.prototype.getVoicings=function(){var a=this.calcPopulation();switch(this.settings.algorithm){case"KORDFU":return this.filterKORDFU(a)}},Tabulous.prototype.setUp=function(){this.tuning=this.getTuning(),this.board=this.getBoard(),this.chord=this.getChord(),this.notes=this.getNotes(),this.voicings=this.getVoicings(0)},Tabulous.prototype.set=function(a,b){this.settings[a]=b,this.setUp()},Tabulous.prototype.calcPopulation=function(a,b){var b=b||[],a=a||0,c=[],d=_.range(a,a+this.settings.span),e=this.tuning,f=_.map(this.notes,function(a){return a.name()+a.accidental()}),g=_.map(e,function(){return-1}),h=_.map(e,function(){return null});_.each(d,function(a){_.each(e,function(b,d){var e=teoria.note.fromKey(b.key()+a),i=e.enharmonics(!0).length?e.enharmonics(!0)[0].name()+e.enharmonics(!0)[0].accidental():"",j=e.name()+e.accidental(),k=_.contains(f,j)||_.contains(f,i),l=_.contains(c,d);!0===k&&!1===l&&(c.push(d),g[d]=a,h[d]=e)})});var i=(b.length>0?_.chain(_.last(b).voicing).compact().sortBy().last().value():0,_.chain(g).compact().sortBy().last().value(),a+1),j=a+this.settings.span<this.settings.frets;b.push({voicing:g,data:h});var k=this.filterDupVoicings(b),l=this.filterInversions(k);return!0===j?this.calcPopulation(i,b):l},Tabulous.prototype.filterDupVoicings=function(a){var b=[],c=[];return _.each(a,function(a){var d=void 0===_.find(b,a.voicing);d&&(b.push(a.voicing),c.push(a))}),c},Tabulous.prototype.filterInversions=function(a){var b=this,c=!1,d=b.settings.root.toLowerCase();return _.each(a,function(a){_.each(a.data,function(a){var b=a.toString(!0);d===b&&(c=!0),a.inverted=c?!1:!0})}),a},Tabulous.prototype.filterKORDFU=function(a){var b=[];return _.each(a,function(a){var c=0,d=[],e=_.contains(a.voicing,0)||_.contains(a.voicing,1),f=_.filter(a.voicing,function(a){return a>0}),g=f.sort()[0];_.each(a.voicing,function(a){var b=(!_.contains([0,-1],a),_.filter(f,function(b){return b===a}).length),h=_.contains(d,a);h||(e||g!==a||(c+=1),e&&g===a&&(c+=b),g!==a&&(c+=b)),d.push(a)}),5>=c&&b.push(a)}),b};